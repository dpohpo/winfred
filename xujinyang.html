<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claude UI (Worker Proxy)</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f7f7f8;
      --border:#e6e6e8;
      --text:#111827;
      --muted:#6b7280;
      --bubble-user:#2563eb;
      --bubble-user-text:#ffffff;
      --bubble-ai:#f3f4f6;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
    }
    .app{height:100%; display:flex; flex-direction:column;}
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.92);
      backdrop-filter:saturate(180%) blur(10px);
      position:sticky; top:0; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:28px;height:28px;border-radius:10px;
      background:linear-gradient(135deg,#111827,#4b5563);
      display:inline-block;
    }
    .title{font-weight:650; letter-spacing:.2px;}
    .actions{display:flex; align-items:center; gap:8px;}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:600;
      color:#111827;
    }
    .btn:hover{background:#fafafa}
    .btn.primary{
      background:#111827;
      border-color:#111827;
      color:#fff;
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.ghost{
      border-color:transparent;
      background:transparent;
      color:#111827;
      padding:8px;
    }
    .btn.ghost:hover{background:#f3f4f6; border-color:#f3f4f6}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
    }

    .settings{
      display:none;
      border-bottom:1px solid var(--border);
      background:var(--panel);
      padding:12px 14px;
    }
    .settings.show{display:block}
    .settings-inner{
      max-width:980px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr .6fr;
      gap:10px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:650;
    }
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    .field input:focus, .field select:focus{border-color:#c7c7cc; box-shadow:0 0 0 3px rgba(0,0,0,.05)}
    .hint{
      grid-column: 1 / -1;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin-top:4px;
    }
    .hint code{font-family:var(--mono); font-size:11px; background:#fff; border:1px solid var(--border); padding:1px 6px; border-radius:8px;}

    .main{
      flex:1;
      overflow:auto;
      padding:18px 14px 8px;
    }
    .wrap{max-width:980px; margin:0 auto;}
    .empty{
      margin:70px auto 0;
      text-align:center;
      color:var(--muted);
    }
    .empty h2{margin:0 0 8px; color:#111827; font-size:22px}
    .empty p{margin:0}
    .msg{
      display:flex;
      margin:14px 0;
      gap:10px;
      align-items:flex-start;
    }
    .msg.user{justify-content:flex-end}
    .bubble{
      max-width:min(760px, 85%);
      padding:12px 14px;
      border-radius:var(--radius);
      line-height:1.5;
      font-size:15px;
      white-space:pre-wrap;
      word-break:break-word;
      box-shadow: none;
    }
    .msg.user .bubble{
      background:var(--bubble-user);
      color:var(--bubble-user-text);
      border-top-right-radius:10px;
    }
    .msg.ai .bubble{
      background:var(--bubble-ai);
      color:var(--text);
      border-top-left-radius:10px;
      border:1px solid rgba(0,0,0,.04);
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
    .loading{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    .dot{
      width:6px;height:6px;border-radius:50%;
      background:#9ca3af;
      animation:bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{
      0%,80%,100%{transform:translateY(0); opacity:.6}
      40%{transform:translateY(-5px); opacity:1}
    }

    .composer{
      border-top:1px solid var(--border);
      padding:12px 14px;
      background:#fff;
    }
    .composer-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      width:100%;
      resize:none;
      min-height:54px;
      max-height:220px;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      outline:none;
      font-size:15px;
      line-height:1.35;
      font-family:var(--sans);
      background:#fff;
    }
    textarea:focus{border-color:#c7c7cc; box-shadow:0 0 0 3px rgba(0,0,0,.05)}
    .send{
      width:54px;height:54px;
      border-radius:16px;
      border:1px solid #111827;
      background:#111827;
      color:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      user-select:none;
    }
    .send:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .footerbar{
      max-width:980px;
      margin:8px auto 0;
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      padding:0 2px 10px;
    }
    .link{
      color:#111827;
      text-decoration:none;
      font-weight:650;
      cursor:pointer;
    }
    .link:hover{text-decoration:underline}
    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      font-size:13px;
      opacity:0;
      transform:translateY(8px);
      transition:.18s;
      z-index:99;
      max-width:min(420px, 92vw);
      white-space:pre-wrap;
    }
    .toast.show{
      opacity:1;
      transform:translateY(0);
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <div class="title">Claude</div>
      <div class="pill" id="statusPill">Proxy: Ready</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnClear" title="清空对话">清空</button>
      <button class="btn" id="btnSettings" title="设置">设置</button>
    </div>
  </div>

  <div class="settings" id="settings">
    <div class="settings-inner">
      <div class="field">
        <label>Worker URL（你的 .workers.dev）</label>
        <input id="workerUrl" type="text" placeholder="https://xxx.workers.dev/" />
      </div>
      <div class="field">
        <label>PROXY_KEY（对应 Worker 的 Secret PROXY_KEY）</label>
        <input id="proxyKey" type="password" placeholder="例如：ou-=1234" />
      </div>
      <div class="field">
        <label>模型（从 /models 自动加载）</label>
        <select id="modelSelect"></select>
      </div>

      <div class="field">
        <label>max_tokens</label>
        <input id="maxTokens" type="number" min="16" max="8192" step="16" />
      </div>
      <div class="field">
        <label>温度（temperature，可选）</label>
        <input id="temperature" type="number" min="0" max="1" step="0.1" />
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn" id="btnReloadModels">刷新模型</button>
        <button class="btn primary" id="btnSave">保存</button>
      </div>

      <div class="hint">
        说明：本页不会使用 <code>x-api-key</code>，你的 Claude Key 已保存在 Worker 的 <code>ANTHROPIC_API_KEY</code> Secret 里；前端只带 <code>x-proxy-key</code> 作为访问口令。<br/>
        如需更安全：在 Worker 里设置 <code>ALLOW_ORIGIN</code> 为你的 Pages 域名，限制只有你的网页可调用。
      </div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="wrap" id="chatWrap">
      <div class="empty" id="empty">
        <h2>开始对话</h2>
        <p>输入消息开始与 Claude 聊天（通过 Cloudflare Worker 代理）</p>
      </div>
      <div id="messages"></div>
      <div id="scrollAnchor"></div>
    </div>
  </div>

  <div class="composer">
    <div class="composer-inner">
      <textarea id="input" placeholder="给 Claude 发消息…（Enter 发送，Shift+Enter 换行）"></textarea>
      <button class="send" id="btnSend" disabled>➤</button>
    </div>
    <div class="footerbar">
      <div>当前模型：<span id="currentModel" style="font-family:var(--mono);"></span></div>
      <div><span class="link" id="openModels">查看模型</span></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
(() => {
  const els = {
    settings: document.getElementById('settings'),
    btnSettings: document.getElementById('btnSettings'),
    btnSave: document.getElementById('btnSave'),
    btnReloadModels: document.getElementById('btnReloadModels'),
    btnClear: document.getElementById('btnClear'),
    workerUrl: document.getElementById('workerUrl'),
    proxyKey: document.getElementById('proxyKey'),
    modelSelect: document.getElementById('modelSelect'),
    maxTokens: document.getElementById('maxTokens'),
    temperature: document.getElementById('temperature'),
    input: document.getElementById('input'),
    btnSend: document.getElementById('btnSend'),
    messages: document.getElementById('messages'),
    empty: document.getElementById('empty'),
    scrollAnchor: document.getElementById('scrollAnchor'),
    statusPill: document.getElementById('statusPill'),
    currentModel: document.getElementById('currentModel'),
    toast: document.getElementById('toast'),
    openModels: document.getElementById('openModels'),
    main: document.getElementById('main'),
  };

  const STORAGE_KEY = 'claude_worker_ui_v1';

  const state = {
    workerUrl: 'https://claude-api-proxy.250786669.workers.dev/',
    proxyKey: 'ou-=1234',
    model: '',
    models: [],
    maxTokens: 1024,
    temperature: '',
    messages: [],
    isLoading: false,
  };

  function toast(msg) {
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    setTimeout(() => els.toast.classList.remove('show'), 2200);
  }

  function saveConfig() {
    const data = {
      workerUrl: state.workerUrl,
      proxyKey: state.proxyKey,
      model: state.model,
      maxTokens: state.maxTokens,
      temperature: state.temperature,
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadConfig() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (data.workerUrl) state.workerUrl = data.workerUrl;
      if (typeof data.proxyKey === 'string') state.proxyKey = data.proxyKey;
      if (data.model) state.model = data.model;
      if (data.maxTokens) state.maxTokens = data.maxTokens;
      if (typeof data.temperature !== 'undefined') state.temperature = data.temperature;
    } catch {}
  }

  function setStatus(text) {
    els.statusPill.textContent = text;
  }

  function scrollToBottom() {
    els.scrollAnchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }

  function autosizeTextarea() {
    const ta = els.input;
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 220) + 'px';
  }

  function renderMessages() {
    els.messages.innerHTML = '';
    if (state.messages.length === 0) {
      els.empty.style.display = 'block';
    } else {
      els.empty.style.display = 'none';
    }

    for (const msg of state.messages) {
      const row = document.createElement('div');
      row.className = 'msg ' + (msg.role === 'user' ? 'user' : 'ai');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = msg.content;

      row.appendChild(bubble);
      els.messages.appendChild(row);
    }
    scrollToBottom();
  }

  function setSendEnabled() {
    const hasText = els.input.value.trim().length > 0;
    els.btnSend.disabled = !hasText || state.isLoading;
  }

  async function fetchModels() {
    setStatus('Proxy: Loading models…');
    try {
      const res = await fetch(new URL('/models', state.workerUrl).toString(), {
        method: 'GET',
        headers: state.proxyKey ? { 'x-proxy-key': state.proxyKey } : {}
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`加载模型失败：${res.status} ${t}`);
      }

      const data = await res.json();
      const models = Array.isArray(data.data) ? data.data : [];
      state.models = models;

      // 填充 select
      els.modelSelect.innerHTML = '';
      for (const m of models) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.display_name ? `${m.display_name} (${m.id})` : m.id;
        els.modelSelect.appendChild(opt);
      }

      // 选择默认模型
      const ids = models.map(m => m.id);
      if (!state.model || !ids.includes(state.model)) {
        // 优先选 Opus 4.5（如果存在）
        const prefer = 'claude-opus-4-5-20251101';
        state.model = ids.includes(prefer) ? prefer : (ids[0] || '');
      }
      els.modelSelect.value = state.model;
      els.currentModel.textContent = state.model || '(none)';

      setStatus('Proxy: Ready');
      toast('模型已加载');
    } catch (e) {
      console.error(e);
      setStatus('Proxy: Error');
      toast(String(e.message || e));
    }
  }

  async function sendMessage() {
    const text = els.input.value.trim();
    if (!text || state.isLoading) return;

    if (!state.workerUrl) return toast('请先设置 Worker URL');
    if (!state.proxyKey) return toast('请先设置 PROXY_KEY');
    if (!state.model) return toast('模型为空，请先刷新模型');

    state.isLoading = true;
    setSendEnabled();
    setStatus('Proxy: Thinking…');

    const userMsg = { role: 'user', content: text };
    state.messages.push(userMsg);
    els.input.value = '';
    autosizeTextarea();
    renderMessages();

    // 组装 Anthropic messages payload
    const payload = {
      model: state.model,
      max_tokens: Number(state.maxTokens) || 1024,
      messages: state.messages.map(m => ({ role: m.role, content: m.content })),
    };
    const temp = (state.temperature === '' || state.temperature === null) ? null : Number(state.temperature);
    if (temp !== null && !Number.isNaN(temp)) payload.temperature = temp;

    try {
      const res = await fetch(state.workerUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-proxy-key': state.proxyKey,
        },
        body: JSON.stringify(payload),
      });

      const raw = await res.text();
      let json = null;
      try { json = JSON.parse(raw); } catch {}

      if (!res.ok) {
        const msg = (json && json.error && json.error.message) ? json.error.message : raw;
        throw new Error(msg || `请求失败：${res.status}`);
      }

      const out = (json && Array.isArray(json.content) && json.content[0] && json.content[0].text)
        ? json.content[0].text
        : (json && json.content && typeof json.content === 'string' ? json.content : '[No content]');

      state.messages.push({ role: 'assistant', content: out });
      renderMessages();
      setStatus('Proxy: Ready');
    } catch (e) {
      console.error(e);
      state.messages.push({ role: 'assistant', content: `错误：${e.message || e}` });
      renderMessages();
      setStatus('Proxy: Error');
    } finally {
      state.isLoading = false;
      setSendEnabled();
    }
  }

  function wireUI() {
    // settings toggle
    els.btnSettings.addEventListener('click', () => {
      els.settings.classList.toggle('show');
    });

    // save config
    els.btnSave.addEventListener('click', async () => {
      state.workerUrl = (els.workerUrl.value || '').trim();
      // 确保以 / 结尾（你的 Worker 地址建议带 /）
      if (state.workerUrl && !state.workerUrl.endsWith('/')) state.workerUrl += '/';

      state.proxyKey = els.proxyKey.value || '';
      state.maxTokens = Number(els.maxTokens.value || 1024);
      state.temperature = els.temperature.value;

      state.model = els.modelSelect.value || state.model;
      els.currentModel.textContent = state.model || '(none)';

      saveConfig();
      toast('已保存');
      await fetchModels();
    });

    // reload models
    els.btnReloadModels.addEventListener('click', fetchModels);

    // model change
    els.modelSelect.addEventListener('change', () => {
      state.model = els.modelSelect.value;
      els.currentModel.textContent = state.model || '(none)';
      saveConfig();
    });

    // clear chat
    els.btnClear.addEventListener('click', () => {
      if (!confirm('确认清空当前对话？')) return;
      state.messages = [];
      renderMessages();
      toast('已清空');
    });

    // send
    els.btnSend.addEventListener('click', sendMessage);

    // enter to send
    els.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    els.input.addEventListener('input', () => {
      autosizeTextarea();
      setSendEnabled();
    });

    // open models in new tab (raw json)
    els.openModels.addEventListener('click', () => {
      const u = new URL('/models', state.workerUrl).toString();
      window.open(u, '_blank');
    });

    // keep current model visible
    els.main.addEventListener('click', () => {
      // optional: close settings when clicking outside (not aggressive)
    });
  }

  function init() {
    loadConfig();

    // fill inputs
    els.workerUrl.value = state.workerUrl;
    els.proxyKey.value = state.proxyKey;
    els.maxTokens.value = state.maxTokens;
    els.temperature.value = state.temperature;

    wireUI();
    autosizeTextarea();
    setSendEnabled();
    renderMessages();

    // load models
    fetchModels();
  }

  init();
})();
</script>
</body>
</html>
